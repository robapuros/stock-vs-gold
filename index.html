<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock vs Gold - Compare Stock Prices in Gold | Real Value Calculator</title>
    <meta name="description" content="See stock prices measured in gold with advanced technical analysis. RSI, MACD, Bollinger Bands, Volume analysis and more.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117; --bg-secondary: #161b22; --bg-card: #21262d;
            --border-color: #30363d; --text-primary: #c9d1d9; --text-secondary: #8b949e;
            --gold: #f0b90b; --positive: #26a69a; --negative: #ef5350;
            --input-bg: #21262d; --input-border: #30363d;
        }
        [data-theme="light"] {
            --bg-primary: #ffffff; --bg-secondary: #f6f8fa; --bg-card: #ffffff;
            --border-color: #d0d7de; --text-primary: #24292f; --text-secondary: #57606a;
            --gold: #d4a000; --positive: #1a7f37; --negative: #cf222e;
            --input-bg: #ffffff; --input-border: #d0d7de;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1600px; margin: 0 auto; padding: 15px; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 1.5rem; background: linear-gradient(90deg, var(--gold), #fcd535); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .theme-toggle { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 1rem; color: var(--text-primary); }
        
        /* Search */
        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-container { position: relative; flex: 1; min-width: 200px; max-width: 350px; }
        input, select { padding: 10px 14px; font-size: 0.95rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); }
        input:focus, select:focus { outline: none; border-color: var(--gold); }
        .search-container input { width: 100%; }
        button { padding: 10px 20px; font-size: 0.95rem; border: none; border-radius: 6px; background: var(--gold); color: #000; font-weight: 600; cursor: pointer; }
        button:hover { opacity: 0.9; }
        
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; margin-top: 4px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; }
        .autocomplete-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .autocomplete-item:hover { background: var(--bg-secondary); }
        .autocomplete-symbol { font-weight: 600; color: var(--gold); }
        .autocomplete-name { font-size: 0.85rem; color: var(--text-secondary); margin-left: 8px; }
        
        /* Stats Bar */
        .stats-bar { display: flex; gap: 20px; padding: 12px 15px; background: var(--bg-card); border-radius: 8px; margin-bottom: 15px; flex-wrap: wrap; border: 1px solid var(--border-color); }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        .stat-value { font-size: 1.1rem; font-weight: 600; }
        .stat-change { font-size: 0.85rem; }
        .positive { color: var(--positive); }
        .negative { color: var(--negative); }
        .gold-text { color: var(--gold); }
        
        /* Chart Controls */
        .chart-controls { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
        .chart-controls label { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; }
        .chart-controls label:hover { border-color: var(--gold); }
        .chart-controls input:checked + span { color: var(--gold); }
        .control-group { display: flex; gap: 5px; padding: 4px; background: var(--bg-secondary); border-radius: 6px; }
        .control-btn { padding: 6px 12px; font-size: 0.8rem; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 4px; }
        .control-btn.active { background: var(--gold); color: #000; }
        
        /* Charts Container */
        .charts-wrapper { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .chart-title { font-size: 1rem; color: var(--text-secondary); margin-bottom: 10px; }
        .main-chart { height: 400px; margin-bottom: 10px; }
        .sub-chart { height: 120px; margin-bottom: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .sub-chart-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px; }
        
        /* Indicator Values */
        .indicator-values { display: flex; gap: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .indicator-item { font-size: 0.85rem; }
        .indicator-name { color: var(--text-secondary); }
        .indicator-value { font-weight: 600; margin-left: 5px; }
        
        /* Metrics Section */
        .metrics-toggle { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; }
        .metrics-header { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .metrics-header h3 { font-size: 1rem; color: var(--gold); }
        .metrics-content { display: none; padding: 15px; border-top: 1px solid var(--border-color); }
        .metrics-content.open { display: block; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .metric-card { padding: 10px; background: var(--bg-secondary); border-radius: 6px; }
        .metric-label { font-size: 0.75rem; color: var(--text-secondary); }
        .metric-value { font-size: 1.1rem; font-weight: 600; }
        .metric-gold { font-size: 0.85rem; color: var(--gold); }
        
        .suggestions-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .suggestion-item { display: inline-block; margin: 5px; padding: 8px 14px; background: var(--bg-secondary); border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background: var(--gold); color: #000; }
        
        .loading { text-align: center; padding: 50px; color: var(--text-secondary); }
        .error { background: rgba(239, 83, 80, 0.1); border: 1px solid var(--negative); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        
        footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.85rem; }
        footer a { color: var(--gold); }
        
        @media (min-width: 769px) { .metrics-content { display: block !important; } .metrics-header { cursor: default; } }
        @media (max-width: 768px) {
            .main-chart { height: 300px; }
            .sub-chart { height: 100px; }
            .stats-bar { gap: 15px; }
            .stat-value { font-size: 1rem; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <header>
            <div class="logo">
                <h1>üìä Stock vs Gold</h1>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
            </div>
        </header>
        
        <div class="search-bar">
            <div class="search-container">
                <input type="text" id="ticker" placeholder="Search stock (AAPL, TSLA...)" value="AAPL" autocomplete="off">
                <div class="autocomplete-list" id="autocomplete"></div>
            </div>
            <select id="years">
                <option value="1">1Y</option>
                <option value="5">5Y</option>
                <option value="10">10Y</option>
                <option value="20">20Y</option>
            </select>
            <button onclick="fetchData()">Analyze</button>
        </div>
        
        <div id="error" class="error" style="display:none;"></div>
        <div id="suggestions" class="suggestions-box" style="display:none;"><h4 style="color:var(--gold);margin-bottom:10px;">Did you mean?</h4><div id="suggestionsList"></div></div>
        
        <div id="results" style="display:none;">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Price (USD)</span>
                    <span class="stat-value" id="priceUsd">-</span>
                    <span class="stat-change" id="changeUsd">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Price (Gold oz)</span>
                    <span class="stat-value gold-text" id="priceGold">-</span>
                    <span class="stat-change" id="changeGold">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Real vs Nominal</span>
                    <span class="stat-value" id="realVsNominal">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">RSI (14)</span>
                    <span class="stat-value" id="rsiValue">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">MACD</span>
                    <span class="stat-value" id="macdValue">-</span>
                </div>
            </div>
            
            <div class="chart-controls">
                <div class="control-group">
                    <button class="control-btn active" onclick="setChartType('line')" id="btnLine">Line</button>
                    <button class="control-btn" onclick="setChartType('candle')" id="btnCandle">Candle</button>
                </div>
                <label><input type="checkbox" id="showGold" checked onchange="updateCharts()"><span>Gold</span></label>
                <label><input type="checkbox" id="showUsd" onchange="updateCharts()"><span>USD</span></label>
                <label><input type="checkbox" id="showSMA" onchange="updateCharts()"><span>SMA</span></label>
                <label><input type="checkbox" id="showEMA" onchange="updateCharts()"><span>EMA</span></label>
                <label><input type="checkbox" id="showBB" onchange="updateCharts()"><span>BB</span></label>
            </div>
            
            <div class="charts-wrapper">
                <div class="chart-title" id="chartTitle">-</div>
                <div class="main-chart"><canvas id="mainChart"></canvas></div>
                
                <div class="sub-chart">
                    <div class="sub-chart-label">Volume</div>
                    <canvas id="volumeChart"></canvas>
                </div>
                
                <div class="sub-chart">
                    <div class="sub-chart-label">RSI (14) ‚Äî Overbought: 70 | Oversold: 30</div>
                    <canvas id="rsiChart"></canvas>
                </div>
                
                <div class="sub-chart">
                    <div class="sub-chart-label">MACD (12, 26, 9)</div>
                    <canvas id="macdChart"></canvas>
                </div>
            </div>
            
            <div class="metrics-toggle">
                <div class="metrics-header" onclick="toggleMetrics()">
                    <h3>üìä Key Metrics & Financials</h3>
                    <span id="metricsArrow">‚ñº</span>
                </div>
                <div class="metrics-content" id="metricsContent">
                    <div class="metrics-grid">
                        <div class="metric-card"><div class="metric-label">Market Cap</div><div class="metric-value" id="marketCap">-</div><div class="metric-gold" id="marketCapGold">-</div></div>
                        <div class="metric-card"><div class="metric-label">P/E Ratio</div><div class="metric-value" id="pe">-</div></div>
                        <div class="metric-card"><div class="metric-label">Forward P/E</div><div class="metric-value" id="forwardPe">-</div></div>
                        <div class="metric-card"><div class="metric-label">PEG Ratio</div><div class="metric-value" id="peg">-</div></div>
                        <div class="metric-card"><div class="metric-label">EPS</div><div class="metric-value" id="eps">-</div></div>
                        <div class="metric-card"><div class="metric-label">Dividend</div><div class="metric-value" id="dividend">-</div></div>
                        <div class="metric-card"><div class="metric-label">Revenue</div><div class="metric-value" id="revenue">-</div><div class="metric-gold" id="revenueGold">-</div></div>
                        <div class="metric-card"><div class="metric-label">Profit Margin</div><div class="metric-value" id="margin">-</div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display:none;">Loading...</div>
        
        <footer>Data: Yahoo Finance | Gold: GC=F | <a href="https://github.com/robapuros/stock-vs-gold">GitHub</a></footer>
    </div>
    
    <script>
        let mainChart, volumeChart, rsiChart, macdChart;
        let currentData = null;
        let chartType = 'line';
        let searchTimeout;
        const isMobile = window.innerWidth <= 768;
        
        function toggleTheme() {
            const body = document.body;
            body.dataset.theme = body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.getElementById('themeBtn').textContent = body.dataset.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', body.dataset.theme);
            if (currentData) updateCharts();
        }
        
        function toggleMetrics() {
            if (window.innerWidth > 768) return;
            document.getElementById('metricsContent').classList.toggle('open');
            document.getElementById('metricsArrow').textContent = document.getElementById('metricsContent').classList.contains('open') ? '‚ñ≤' : '‚ñº';
        }
        
        function setChartType(type) {
            chartType = type;
            document.getElementById('btnLine').classList.toggle('active', type === 'line');
            document.getElementById('btnCandle').classList.toggle('active', type === 'candle');
            if (currentData) updateCharts();
        }
        
        // Autocomplete
        const tickerInput = document.getElementById('ticker');
        const autocompleteList = document.getElementById('autocomplete');
        
        tickerInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            if (this.value.length < 1) { autocompleteList.style.display = 'none'; return; }
            searchTimeout = setTimeout(() => searchTickers(this.value), 300);
        });
        
        document.addEventListener('click', e => {
            if (!tickerInput.contains(e.target)) autocompleteList.style.display = 'none';
        });
        
        async function searchTickers(q) {
            try {
                const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                const d = await r.json();
                if (d.results?.length) {
                    autocompleteList.innerHTML = d.results.map(r => `<div class="autocomplete-item" onclick="selectTicker('${r.symbol}')"><span class="autocomplete-symbol">${r.symbol}</span><span class="autocomplete-name">${r.name}</span></div>`).join('');
                    autocompleteList.style.display = 'block';
                } else autocompleteList.style.display = 'none';
            } catch(e) { autocompleteList.style.display = 'none'; }
        }
        
        function selectTicker(s) { tickerInput.value = s; autocompleteList.style.display = 'none'; fetchData(); }
        
        function fmt(n) {
            if (n == null) return '-';
            if (n >= 1e12) return (n/1e12).toFixed(2)+'T';
            if (n >= 1e9) return (n/1e9).toFixed(2)+'B';
            if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
            return n.toLocaleString();
        }
        
        function fmtGold(n) { return n == null ? '-' : (n >= 1e6 ? (n/1e6).toFixed(2)+'M oz' : n.toFixed(4)+' oz'); }
        
        async function fetchData() {
            const ticker = tickerInput.value.trim().toUpperCase();
            const years = document.getElementById('years').value;
            if (!ticker) return;
            
            const url = new URL(window.location);
            url.searchParams.set('ticker', ticker);
            url.searchParams.set('years', years);
            window.history.replaceState({}, '', url);
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('suggestions').style.display = 'none';
            
            try {
                const r = await fetch(`/api/data?ticker=${encodeURIComponent(ticker)}&years=${years}`);
                const data = await r.json();
                if (data.error) {
                    document.getElementById('error').textContent = data.error;
                    document.getElementById('error').style.display = 'block';
                    if (data.suggestions?.length) {
                        document.getElementById('suggestionsList').innerHTML = data.suggestions.map(s => `<span class="suggestion-item" onclick="selectTicker('${s.symbol}')">${s.symbol}</span>`).join('');
                        document.getElementById('suggestions').style.display = 'block';
                    }
                    return;
                }
                currentData = data;
                displayData(data);
            } catch(e) {
                document.getElementById('error').textContent = 'Failed to load data';
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayData(d) {
            const s = d.stats, m = d.metrics, t = d.technical;
            
            document.getElementById('priceUsd').textContent = '$' + s.end_price_usd;
            document.getElementById('changeUsd').textContent = (s.change_usd_pct >= 0 ? '+' : '') + s.change_usd_pct + '%';
            document.getElementById('changeUsd').className = 'stat-change ' + (s.change_usd_pct >= 0 ? 'positive' : 'negative');
            
            document.getElementById('priceGold').textContent = s.end_price_gold.toFixed(4) + ' oz';
            document.getElementById('changeGold').textContent = (s.change_gold_pct >= 0 ? '+' : '') + s.change_gold_pct + '%';
            document.getElementById('changeGold').className = 'stat-change ' + (s.change_gold_pct >= 0 ? 'positive' : 'negative');
            
            const diff = s.change_usd_pct - s.change_gold_pct;
            document.getElementById('realVsNominal').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%';
            document.getElementById('realVsNominal').className = 'stat-value ' + (diff >= 0 ? 'positive' : 'negative');
            
            document.getElementById('rsiValue').textContent = t.current_rsi?.toFixed(1) || '-';
            document.getElementById('rsiValue').className = 'stat-value ' + (t.current_rsi > 70 ? 'negative' : t.current_rsi < 30 ? 'positive' : '');
            
            const macdDiff = t.current_macd && t.current_macd_signal ? t.current_macd - t.current_macd_signal : null;
            document.getElementById('macdValue').textContent = macdDiff?.toFixed(6) || '-';
            document.getElementById('macdValue').className = 'stat-value ' + (macdDiff > 0 ? 'positive' : macdDiff < 0 ? 'negative' : '');
            
            document.getElementById('marketCap').textContent = m.market_cap_usd ? '$' + fmt(m.market_cap_usd) : '-';
            document.getElementById('marketCapGold').textContent = m.market_cap_gold ? fmtGold(m.market_cap_gold) : '';
            document.getElementById('pe').textContent = m.pe_ratio ?? '-';
            document.getElementById('forwardPe').textContent = m.forward_pe ?? '-';
            document.getElementById('peg').textContent = m.peg_ratio ?? '-';
            document.getElementById('eps').textContent = m.eps ? '$' + m.eps : '-';
            document.getElementById('dividend').textContent = m.dividend_yield ? m.dividend_yield + '%' : '-';
            document.getElementById('revenue').textContent = m.revenue_usd ? '$' + fmt(m.revenue_usd) : '-';
            document.getElementById('revenueGold').textContent = m.revenue_gold ? fmtGold(m.revenue_gold) : '';
            document.getElementById('margin').textContent = m.profit_margin ? m.profit_margin + '%' : '-';
            
            document.getElementById('chartTitle').textContent = `${d.company_name} (${d.ticker})`;
            document.getElementById('results').style.display = 'block';
            document.title = `${d.ticker} vs Gold | Stock vs Gold`;
            
            updateCharts();
        }
        
        function getColors() {
            const dark = document.body.dataset.theme === 'dark';
            return {
                text: dark ? '#8b949e' : '#57606a',
                grid: dark ? '#30363d' : '#d0d7de',
                gold: '#f0b90b',
                green: '#26a69a',
                red: '#ef5350',
                blue: '#2196f3',
                purple: '#9c27b0',
                orange: '#ff9800'
            };
        }
        
        function updateCharts() {
            if (!currentData) return;
            const c = getColors();
            const d = currentData;
            const t = d.technical;
            
            // Destroy existing charts
            [mainChart, volumeChart, rsiChart, macdChart].forEach(ch => ch?.destroy());
            
            // Main Chart
            const mainDatasets = [];
            if (document.getElementById('showGold').checked) {
                mainDatasets.push({ label: 'Gold (oz)', data: d.stock_in_gold, borderColor: c.gold, borderWidth: 2, pointRadius: 0, yAxisID: 'y' });
            }
            if (document.getElementById('showUsd').checked) {
                mainDatasets.push({ label: 'USD', data: d.stock_usd, borderColor: c.green, borderWidth: 2, pointRadius: 0, yAxisID: 'y1' });
            }
            if (document.getElementById('showSMA').checked) {
                if (t.sma_20) mainDatasets.push({ label: 'SMA20', data: t.sma_20, borderColor: c.red, borderWidth: 1, pointRadius: 0, borderDash: [5,5], yAxisID: 'y' });
                if (t.sma_50) mainDatasets.push({ label: 'SMA50', data: t.sma_50, borderColor: c.blue, borderWidth: 1, pointRadius: 0, borderDash: [5,5], yAxisID: 'y' });
            }
            if (document.getElementById('showEMA').checked) {
                if (t.ema_12) mainDatasets.push({ label: 'EMA12', data: t.ema_12, borderColor: c.orange, borderWidth: 1, pointRadius: 0, yAxisID: 'y' });
                if (t.ema_26) mainDatasets.push({ label: 'EMA26', data: t.ema_26, borderColor: c.purple, borderWidth: 1, pointRadius: 0, yAxisID: 'y' });
            }
            if (document.getElementById('showBB').checked && t.bb_upper) {
                mainDatasets.push({ label: 'BB+', data: t.bb_upper, borderColor: 'rgba(156,39,176,0.5)', borderWidth: 1, pointRadius: 0, fill: false, yAxisID: 'y' });
                mainDatasets.push({ label: 'BB-', data: t.bb_lower, borderColor: 'rgba(156,39,176,0.5)', borderWidth: 1, pointRadius: 0, fill: '-1', backgroundColor: 'rgba(156,39,176,0.1)', yAxisID: 'y' });
            }
            
            mainChart = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { labels: d.dates, datasets: mainDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: true, labels: { color: c.text, boxWidth: 12 } } },
                    scales: {
                        x: { ticks: { color: c.text, maxTicksLimit: isMobile ? 5 : 10 }, grid: { color: c.grid } },
                        y: { position: 'left', ticks: { color: c.gold }, grid: { color: c.grid } },
                        y1: { position: 'right', display: document.getElementById('showUsd').checked, ticks: { color: c.green }, grid: { drawOnChartArea: false } }
                    }
                }
            });
            
            // Volume Chart
            const volColors = d.stock_in_gold.map((v, i) => i > 0 && v >= d.stock_in_gold[i-1] ? c.green : c.red);
            volumeChart = new Chart(document.getElementById('volumeChart'), {
                type: 'bar',
                data: { labels: d.dates, datasets: [{ data: d.volume, backgroundColor: volColors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { ticks: { color: c.text, callback: v => fmt(v) }, grid: { color: c.grid } }
                    }
                }
            });
            
            // RSI Chart
            rsiChart = new Chart(document.getElementById('rsiChart'), {
                type: 'line',
                data: {
                    labels: d.dates,
                    datasets: [
                        { data: t.rsi, borderColor: c.purple, borderWidth: 1.5, pointRadius: 0, fill: false },
                        { data: Array(d.dates.length).fill(70), borderColor: c.red, borderWidth: 1, borderDash: [3,3], pointRadius: 0 },
                        { data: Array(d.dates.length).fill(30), borderColor: c.green, borderWidth: 1, borderDash: [3,3], pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { min: 0, max: 100, ticks: { color: c.text, stepSize: 50 }, grid: { color: c.grid } }
                    }
                }
            });
            
            // MACD Chart
            const histColors = t.macd_histogram.map(v => v >= 0 ? c.green : c.red);
            macdChart = new Chart(document.getElementById('macdChart'), {
                type: 'bar',
                data: {
                    labels: d.dates,
                    datasets: [
                        { type: 'bar', data: t.macd_histogram, backgroundColor: histColors, borderWidth: 0 },
                        { type: 'line', data: t.macd, borderColor: c.blue, borderWidth: 1.5, pointRadius: 0 },
                        { type: 'line', data: t.macd_signal, borderColor: c.orange, borderWidth: 1.5, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { ticks: { color: c.text }, grid: { color: c.grid } }
                    }
                }
            });
        }
        
        tickerInput.addEventListener('keypress', e => { if (e.key === 'Enter') { autocompleteList.style.display = 'none'; fetchData(); } });
        
        window.onload = () => {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') { document.body.dataset.theme = 'light'; document.getElementById('themeBtn').textContent = 'üåô'; }
            const p = new URLSearchParams(window.location.search);
            if (p.get('ticker')) tickerInput.value = p.get('ticker');
            if (p.get('years')) document.getElementById('years').value = p.get('years');
            else if (isMobile) document.getElementById('years').value = '1';
            fetchData();
        };
    </script>
</body>
</html>
